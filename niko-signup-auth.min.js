(()=>{"use strict";!function(e){const t="/dev/app/customer/dashboard",o="/dev/app/retailer/dashboard",r="/dev/app/auth/log-in";e.NikoAuthCore=new class{constructor(){this.supabase=null,this.initialized=!1,this.init()}async init(){console.log("Loading Niko Auth Core v3.0.0 (Modular)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"),this.initialized=!0,console.log("Niko Auth Core initialized successfully"),this.setupLogoutHandlers(),this.checkAuthState()}isInitialized(){return this.initialized}loadSupabase(){return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",o.onload=e,o.onerror=t,document.head.appendChild(o)})}async register(e,t,o,r){if(console.log("Registering user:",{email:e,userType:r}),!this.initialized)throw new Error("Authentication system not initialized");try{const s=document.querySelector("base")?.href||location.origin+"/",a="Customer"===r?s+"app/customer/onboarding":s+"app/retailer/onboarding",{data:i,error:n}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{name:o,user_type:r,role:r},emailRedirectTo:a}});return n?(console.error("Registration error:",n),{success:!1,error:n.message}):(console.log("Registration successful:",i.user?.email),await this.createWebflowRecord(i.user.id,e,o,r),{success:!0,user:i.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(e,t){if(console.log("Logging in user:",{email:e}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:o,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:t});return r?(console.error("Login error:",r),{success:!1,error:r.message}):(console.log("Login successful:",o.user?.email),{success:!0,user:o.user})}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return localStorage.clear(),sessionStorage.clear(),e?(console.error("Logout error:",e),{success:!1,error:e.message}):(console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async createWebflowRecord(e,t,o,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:t,name:o,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}getRedirectUrl(e){return"Customer"===e?t:o}setupLogoutHandlers(){if("undefined"==typeof document)return;const t=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{t.includes(e)||t.push(e)})}),console.log(`Found ${t.length} logout elements`),t.forEach(t=>{const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("Logout button clicked");const s=o.textContent;try{o.textContent="Logging out...",o.disabled=!0;const t=await this.logout();console.log("Logout result:",t),e.location.href=r}catch(t){console.error("Logout error:",t),o.textContent=s,o.disabled=!1,e.location.href=r}})}),console.log(`Setup ${t.length} logout handlers`)}async checkAuthState(){if("undefined"!=typeof document)try{const t=await this.getCurrentUser();t?(this.displayUserInfo(t),console.log("User authenticated:",t.email)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),e.location.href=r)}catch(e){console.error("Auth state check failed:",e)}}displayUserInfo(e){if("undefined"==typeof document)return;const t=e.user_metadata?.name||e.email.split("@")[0],o=e.user_metadata?.user_type||"Customer",r={name:['[data-user="name"]','[niko-data="user-name"]',".user-name","#user-name"],email:['[data-user="email"]','[niko-data="user-email"]',".user-email","#user-email"],role:['[data-user="role"]','[niko-data="user-role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),r.email.forEach(t=>{document.querySelectorAll(t).forEach(t=>t.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),console.log("User info displayed")}isProtectedPage(){return void 0!==e&&["/dev/app/customer/","/dev/app/retailer/","/dashboard","/profile"].some(t=>e.location.pathname.includes(t))}},e.nikologout=async function(){e.NikoAuthCore&&(await e.NikoAuthCore.logout(),e.location.href=r)}}(window),function(e){const t="/dev/app/customer/dashboard",o="/dev/app/retailer/dashboard",r="/dev/app/auth/log-in";e.NikoAuth=new class{constructor(){this.supabase=null,this.initialized=!1,this.init()}async init(){console.log("Loading Niko Auth Core v3.0.0 (Modular)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"),this.initialized=!0,console.log("Niko Auth Core initialized successfully"),this.setupLogoutHandlers(),this.checkAuthState()}isInitialized(){return this.initialized}loadSupabase(){return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",o.onload=e,o.onerror=t,document.head.appendChild(o)})}async register(e,t,o,r){if(console.log("Registering user:",{email:e,userType:r}),!this.initialized)throw new Error("Authentication system not initialized");try{const s=document.querySelector("base")?.href||location.origin+"/",a="retailer"===r.toLowerCase()?s+"dev/app/retailer/onboarding":s+"dev/app/customer/onboarding",{data:i,error:n}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{name:o,user_type:r.toLowerCase(),role:r.toLowerCase()},emailRedirectTo:a}});return n?(console.error("Registration error:",n),{success:!1,error:n.message}):(console.log("Registration successful:",i.user?.email),await this.createWebflowRecord(i.user.id,e,o,r),{success:!0,user:i.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(e,t){if(console.log("Logging in user:",{email:e}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:o,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:t});return r?(console.error("Login error:",r),{success:!1,error:r.message}):(console.log("Login successful:",o.user?.email),{success:!0,user:o.user})}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return localStorage.clear(),sessionStorage.clear(),e?(console.error("Logout error:",e),{success:!1,error:e.message}):(console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async createWebflowRecord(e,t,o,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:t,name:o,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}getRedirectUrl(e){return"retailer"===e.toLowerCase()?o:t}setupLogoutHandlers(){if("undefined"==typeof document)return;const t=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{t.includes(e)||t.push(e)})}),console.log(`Found ${t.length} logout elements`),t.forEach(t=>{const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("Logout button clicked");const s=o.textContent;try{o.textContent="Logging out...",o.disabled=!0;const t=await this.logout();console.log("Logout result:",t),e.location.href=r}catch(t){console.error("Logout error:",t),o.textContent=s,o.disabled=!1,e.location.href=r}})}),console.log(`Setup ${t.length} logout handlers`)}async checkAuthState(){if("undefined"!=typeof document)try{const t=await this.getCurrentUser();t?(this.displayUserInfo(t),console.log("User authenticated:",t.email)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),e.location.href=r)}catch(e){console.error("Auth state check failed:",e)}}displayUserInfo(e){if("undefined"==typeof document)return;const t=e.user_metadata?.name||e.email.split("@")[0],o=e.user_metadata?.user_type||"customer",r={name:['[data-user="name"]','[niko-data="user-name"]',".user-name","#user-name"],email:['[data-user="email"]','[niko-data="user-email"]',".user-email","#user-email"],role:['[data-user="role"]','[niko-data="user-role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),r.email.forEach(t=>{document.querySelectorAll(t).forEach(t=>t.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),console.log("User info displayed")}isProtectedPage(){return void 0!==e&&["/dev/app/customer/","/dev/app/retailer/","/dashboard","/profile"].some(t=>e.location.pathname.includes(t))}},e.nikologout=async function(){e.NikoAuth&&(await e.NikoAuth.logout(),e.location.href=r)}}(window),function(e){e.NikoSignupFormHandler=new class{constructor(){this.initialized=!1,this.init()}async init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.setupFormHandlers()):this.setupFormHandlers()}setupFormHandlers(){console.log("SignupFormHandler: Setting up form handlers"),document.querySelectorAll('form[data-name="Signup Form"],form[data-name="wf-form-Signup-Form"],#wf-form-Signup-Form').forEach(e=>{console.log("SignupFormHandler: Found signup form:",e.getAttribute("data-name")||e.id),this.interceptWebflowForm(e)}),document.querySelectorAll('[niko-data="signup-form"],[data-auth-form="signup"]').forEach(e=>{console.log("SignupFormHandler: Found auth form"),this.interceptWebflowForm(e)})}interceptWebflowForm(t){const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("submit",async t=>{t.preventDefault(),t.stopPropagation(),console.log("SignupFormHandler: Form submission intercepted");const r=new FormData(o),s=r.get("email")||r.get("Email"),a=r.get("password")||r.get("Password"),i=r.get("name")||r.get("Name")||r.get("Full-Name");let n=r.get("user_type")||r.get("User-Type");if(!n){const e=document.querySelector(".w-tab-link.w--current,[data-user-type].w--current");e&&(n=e.getAttribute("data-user-type")||e.textContent.trim())}if(n=n||"Customer",console.log("SignupFormHandler: Form data:",{email:s,name:i,userType:n}),s&&a){this.showLoading(o);try{await this.waitForNikoAuth();const t=await e.NikoAuth.register(s,a,i,n);if(t.success){console.log("SignupFormHandler: Registration successful"),this.showSuccessModal(s),o.style.display="none";const e=o.parentElement.querySelector(".w-form-done");e&&(e.style.display="block")}else console.error("SignupFormHandler: Registration failed:",t.error),this.showError(o,t.error||"Registration failed. Please try again."),this.hideLoading(o)}catch(e){console.error("SignupFormHandler: Error:",e),this.showError(o,"An error occurred. Please try again."),this.hideLoading(o)}}else this.showError(o,"Please fill in all required fields")})}async waitForNikoAuth(){let t=0;for(;t<50;){if(e.NikoAuth&&e.NikoAuth.isInitialized())return;await new Promise(e=>setTimeout(e,100)),t++}throw new Error("NikoAuth not initialized")}showLoading(e){const t=e.querySelector('input[type="submit"],button[type="submit"]');t&&(t.disabled=!0,t.dataset.originalText=t.value||t.textContent,t.value?t.value="Creating account...":t.textContent="Creating account...")}hideLoading(e){const t=e.querySelector('input[type="submit"],button[type="submit"]');t&&t.dataset.originalText&&(t.disabled=!1,void 0!==t.value?t.value=t.dataset.originalText:t.textContent=t.dataset.originalText)}showError(e,t){const o=e.parentElement.querySelector(".w-form-fail");if(o){const e=o.querySelector("div");e&&(e.textContent=t),o.style.display="block"}else{const o=document.createElement("div");o.className="form-error-message",o.style.cssText="color:red;margin-top:10px;padding:10px;background:#fee;border-radius:4px;",o.textContent=t,e.appendChild(o),setTimeout(()=>o.remove(),5e3)}}showSuccessModal(e){const t=document.querySelector('[niko-data="email-confirmation-modal"],#email-confirmation-modal,.email-confirmation-modal');if(t){const o=t.querySelector('[niko-data="user-email"],.user-email,span.email');o&&(o.textContent=e),t.style.display="flex",t.classList.add("is-visible"),t.querySelectorAll('[niko-data="close-modal"],.close-modal,.modal-close').forEach(e=>{e.addEventListener("click",()=>{t.style.display="none",t.classList.remove("is-visible")})})}else this.createEmailConfirmationModal(e)}createEmailConfirmationModal(e){const t=document.createElement("div");t.className="niko-email-confirmation-modal",t.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;",t.innerHTML=`<div style="background:white;padding:40px;border-radius:8px;max-width:500px;text-align:center;"><h2 style="margin-bottom:20px;">Check Your Email!</h2><p style="margin-bottom:20px;">We've sent a confirmation email to:</p><p style="font-weight:bold;margin-bottom:20px;">${e}</p><p style="margin-bottom:30px;">Please click the link in the email to complete your registration.</p><button onclick="this.closest('.niko-email-confirmation-modal').remove()" style="padding:10px 30px;background:#333;color:white;border:none;border-radius:4px;cursor:pointer;">OK</button></div>`,document.body.appendChild(t)}}}(window)})();