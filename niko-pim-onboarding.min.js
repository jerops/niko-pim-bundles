(()=>{"use strict";!function(e){console.log("🚀 Loading Niko Onboarding Bundle v1.0.0");const t="/app/customer/dashboard",o="/app/retailer/dashboard";class i{constructor(){this.initialized=!1,this.currentStep=1,this.totalSteps=3,this.formData={},this.userType=null,this.init()}async init(){console.log("📋 Initializing Onboarding Manager..."),e.NikoAuthCore||(console.log("⏳ Waiting for NikoAuthCore..."),await this.waitForAuth());const t=await e.NikoAuthCore.getCurrentUser();return t?(this.userType=t.user_metadata?.user_type||"customer",console.log("👤 User type:",this.userType),await e.NikoAuthCore.checkOnboardingStatus(t.id)?(console.log("✅ Onboarding already completed, redirecting to dashboard..."),void this.redirectToDashboard()):(this.initialized=!0,this.setupFormHandlers(),this.setupNavigationHandlers(),this.updateProgressBar(),void console.log("✅ Onboarding Manager initialized"))):(console.error("❌ No authenticated user found"),void(e.location.href="/app/auth/log-in"))}waitForAuth(){return new Promise(t=>{const o=setInterval(()=>{e.NikoAuthCore&&e.NikoAuthCore.initialized&&(clearInterval(o),t())},100)})}setupFormHandlers(){document.querySelectorAll("[niko-onboarding-input]").forEach(e=>{const t=e.getAttribute("niko-onboarding-input");this.formData[t]&&(e.value=this.formData[t]),e.addEventListener("change",e=>{this.formData[t]=e.target.value,this.saveProgress()}),e.addEventListener("blur",()=>{this.validateField(e)})});const e=document.querySelector('[niko-onboarding="submit"]');e&&e.addEventListener("click",e=>{e.preventDefault(),this.submitOnboarding()})}setupNavigationHandlers(){document.querySelectorAll('[niko-onboarding="next"]').forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),this.validateCurrentStep()&&this.nextStep()})}),document.querySelectorAll('[niko-onboarding="prev"]').forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),this.previousStep()})}),document.querySelectorAll("[niko-onboarding-step]").forEach(e=>{e.addEventListener("click",t=>{const o=parseInt(e.getAttribute("niko-onboarding-step"));o<=this.currentStep&&this.goToStep(o)})})}validateField(e){e.getAttribute("niko-onboarding-input");const t=e.hasAttribute("required"),o=e.type;let i=!0,r="";if(t&&!e.value.trim())i=!1,r="This field is required";else if("email"===o&&e.value)/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.value)||(i=!1,r="Please enter a valid email address");else if("url"===o&&e.value)try{new URL(e.value)}catch{i=!1,r="Please enter a valid URL"}const s=e.parentElement.querySelector(".error-message");return s&&(s.textContent=r,s.style.display=i?"none":"block"),i?e.classList.remove("error"):e.classList.add("error"),i}validateCurrentStep(){const e=document.querySelector(`[niko-onboarding-step="${this.currentStep}"]`);if(!e)return!0;const t=e.querySelectorAll("[niko-onboarding-input][required]");let o=!0;return t.forEach(e=>{this.validateField(e)||(o=!1)}),o||this.showNotification("Please fill in all required fields","error"),o}nextStep(){this.currentStep<this.totalSteps&&(this.hideStep(this.currentStep),this.currentStep++,this.showStep(this.currentStep),this.updateProgressBar(),this.saveProgress())}previousStep(){this.currentStep>1&&(this.hideStep(this.currentStep),this.currentStep--,this.showStep(this.currentStep),this.updateProgressBar())}goToStep(e){e>=1&&e<=this.totalSteps&&e!==this.currentStep&&(this.hideStep(this.currentStep),this.currentStep=e,this.showStep(this.currentStep),this.updateProgressBar())}showStep(e){const t=document.querySelector(`[niko-onboarding-step="${e}"]`);t&&(t.style.display="block",t.classList.add("active"))}hideStep(e){const t=document.querySelector(`[niko-onboarding-step="${e}"]`);t&&(t.style.display="none",t.classList.remove("active"))}updateProgressBar(){const e=this.currentStep/this.totalSteps*100,t=document.querySelector('[niko-onboarding="progress-bar"]');t&&(t.style.width=`${e}%`);const o=document.querySelector('[niko-onboarding="progress-text"]');o&&(o.textContent=`Step ${this.currentStep} of ${this.totalSteps}`),document.querySelectorAll("[niko-onboarding-indicator]").forEach((e,t)=>{const o=t+1;o<this.currentStep?(e.classList.add("completed"),e.classList.remove("active")):o===this.currentStep?(e.classList.add("active"),e.classList.remove("completed")):e.classList.remove("active","completed")})}async submitOnboarding(){if(console.log("📤 Submitting onboarding data..."),!this.validateAllFields())return void this.showNotification("Please complete all required fields","error");const t=document.querySelector('[niko-onboarding="submit"]'),o=t?.textContent;t&&(t.textContent="Submitting...",t.disabled=!0);try{if(!await e.NikoAuthCore.getCurrentUser())throw new Error("User not authenticated");const{data:{session:t}}=await e.NikoAuthCore.supabase.auth.getSession();if(!t)throw new Error("No active session");const o=await fetch("https://bzjoxjqfpmjhbfijthpp.supabase.co/functions/v1/complete-onboarding",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"},body:JSON.stringify(this.formData)}),i=await o.json();if(!o.ok||!i.success)throw new Error(i.error||"Failed to complete onboarding");console.log("✅ Onboarding completed successfully!"),this.showNotification("Onboarding completed! Redirecting to dashboard...","success"),this.clearProgress(),setTimeout(()=>{this.redirectToDashboard()},2e3)}catch(e){console.error("❌ Onboarding submission failed:",e),this.showNotification(e.message||"Failed to complete onboarding","error"),t&&(t.textContent=o,t.disabled=!1)}}validateAllFields(){const e=document.querySelectorAll("[niko-onboarding-input][required]");let t=!0;return e.forEach(e=>{this.validateField(e)||(t=!1)}),t}saveProgress(){try{localStorage.setItem("niko_onboarding_progress",JSON.stringify({step:this.currentStep,data:this.formData,timestamp:Date.now()}))}catch(e){console.error("Failed to save progress:",e)}}loadProgress(){try{const e=localStorage.getItem("niko_onboarding_progress");if(e){const t=JSON.parse(e);if(Date.now()-t.timestamp<864e5)return this.currentStep=t.step||1,this.formData=t.data||{},!0}}catch(e){console.error("Failed to load progress:",e)}return!1}clearProgress(){try{localStorage.removeItem("niko_onboarding_progress")}catch(e){console.error("Failed to clear progress:",e)}}showNotification(e,t="info"){let o=document.querySelector('[niko-onboarding="notification"]');o||(o=document.createElement("div"),o.setAttribute("niko-onboarding","notification"),o.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          padding: 16px 24px;\n          border-radius: 8px;\n          z-index: 9999;\n          transition: opacity 0.3s;\n        ",document.body.appendChild(o));const i={success:"background: #10b981; color: white;",error:"background: #ef4444; color: white;",info:"background: #3b82f6; color: white;"};o.style.cssText+=i[t]||i.info,o.textContent=e,o.style.display="block",o.style.opacity="1",setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.style.display="none"},300)},5e3)}redirectToDashboard(){const i="retailer"===this.userType?o:t;e.location.href=e.location.origin+i}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.NikoOnboarding=new i}):e.NikoOnboarding=new i,console.log("✅ Niko Onboarding Bundle loaded - Available as window.NikoOnboarding")}(window)})();