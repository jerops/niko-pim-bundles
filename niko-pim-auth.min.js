(()=>{"use strict";!function(e){const o="/dev/app/customer/dashboard",t="/dev/app/retailer/dashboard",r="/dev/app/auth/log-in";e.NikoAuthCore=new class{constructor(){this.supabase=null,this.initialized=!1,this.init()}async init(){console.log("Loading Niko Auth Core v3.0.0 (Modular)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"),this.initialized=!0,console.log("Niko Auth Core initialized successfully"),this.setupLogoutHandlers(),this.checkAuthState()}isInitialized(){return this.initialized}loadSupabase(){return new Promise((e,o)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",t.onload=e,t.onerror=o,document.head.appendChild(t)})}async register(e,o,t,r){if(console.log("Registering user:",{email:e,userType:r}),!this.initialized)throw new Error("Authentication system not initialized");try{const s=document.querySelector("base")?.href||location.origin+"/",a="retailer"===r.toLowerCase()?s+"dev/app/retailer/onboarding":s+"dev/app/customer/onboarding",{data:i,error:n}=await this.supabase.auth.signUp({email:e,password:o,options:{data:{name:t,user_type:r.toLowerCase(),role:r.toLowerCase()},emailRedirectTo:a}});return n?(console.error("Registration error:",n),{success:!1,error:n.message}):(console.log("Registration successful:",i.user?.email),await this.createWebflowRecord(i.user.id,e,t,r),{success:!0,user:i.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(e,o){if(console.log("Logging in user:",{email:e}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:t,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:o});return r?(console.error("Login error:",r),{success:!1,error:r.message}):(console.log("Login successful:",t.user?.email),{success:!0,user:t.user})}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return localStorage.clear(),sessionStorage.clear(),e?(console.error("Logout error:",e),{success:!1,error:e.message}):(console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:o}=await this.supabase.auth.getUser();if(o)throw o;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async createWebflowRecord(e,o,t,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:o,name:t,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}getRedirectUrl(e){return"retailer"===e.toLowerCase()?t:o}setupLogoutHandlers(){if("undefined"==typeof document)return;const o=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{o.includes(e)||o.push(e)})}),console.log(`Found ${o.length} logout elements`),o.forEach(o=>{const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("Logout button clicked");const s=t.textContent;try{t.textContent="Logging out...",t.disabled=!0;const o=await this.logout();console.log("Logout result:",o),e.location.href=r}catch(o){console.error("Logout error:",o),t.textContent=s,t.disabled=!1,e.location.href=r}})}),console.log(`Setup ${o.length} logout handlers`)}async checkAuthState(){if("undefined"!=typeof document)try{const o=await this.getCurrentUser();o?(this.displayUserInfo(o),console.log("User authenticated:",o.email)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),e.location.href=r)}catch(e){console.error("Auth state check failed:",e)}}displayUserInfo(e){if("undefined"==typeof document)return;const o=e.user_metadata?.name||e.email.split("@")[0],t=e.user_metadata?.user_type||"customer",r={name:['[data-user="name"]','[niko-data="user-name"]',".user-name","#user-name"],email:['[data-user="email"]','[niko-data="user-email"]',".user-email","#user-email"],role:['[data-user="role"]','[niko-data="user-role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),r.email.forEach(o=>{document.querySelectorAll(o).forEach(o=>o.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),console.log("User info displayed")}isProtectedPage(){return void 0!==e&&["/dev/app/customer/","/dev/app/retailer/","/dashboard","/profile"].some(o=>e.location.pathname.includes(o))}},e.NikoAuth=e.NikoAuthCore,e.nikologout=async function(){e.NikoAuthCore&&(await e.NikoAuthCore.logout(),e.location.href=r)}}(window)})();